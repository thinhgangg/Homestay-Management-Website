<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chi tiết Homestay</title>
    <link rel="stylesheet" href="assets/css/homestay.css" />
    <link rel="stylesheet" href="assets/css/header.css" />
    <script src="assets/js/restrictPageAccess.js"></script>
    <link
      rel="stylesheet"
      href="./assets/fonts/themify-icons/themify-icons.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
    />
  </head>
  <body>
    <!-- Header -->
    <header>
      <div class="header-container">
        <div class="container1">
          <div class="header-content">
            <div class="logo">
              <a href="trang-chu.html">
                <img
                  class="logo-image"
                  src="assets/img/gotravel_logo_air.png"
                  alt=""
                />
              </a>
            </div>
            <nav class="nav">
              <ul>
                <li><a href="trang-chu.html">TRANG CHỦ</a></li>
                <li><a href="homestay-list.html">HOMESTAYS</a></li>
                <li><a href="about.html" target="_blank">VỀ CHÚNG TÔI</a></li>
                <li><a href="contact.html" target="_blank">LIÊN HỆ</a></li>
              </ul>
            </nav>
          </div>
        </div>

        <div class="btns desktop-btns" id="auth-buttons">
          <button class="cooperate-btn" onclick="location.href='partnership.html'">Hợp tác với chúng tôi</button>
          <button class="dang-ky-btn signup" id="registerBtn">Đăng ký</button>
          <button class="dang-nhap-btn login" id="loginBtn">Đăng nhập</button>
        </div>

        <div id="user-info" class="user-dropdown" style="display: none; position: relative">
          <img src="/assets/img/icon/user.svg" alt="user-icon" id="user-icon" />
          <div id="user-menu" class="dropdown-menu">
            <a href="#" id="profileLink" class="dropdown-item">Hồ sơ</a>
            <button id="logoutBtn" class="dropdown-item">Đăng xuất</button>
          </div>
        </div>
      </div>
    </header>

    <div class="hero">
      <div class="search-box">
        <div class="date-picker">
          <div class="date1">
            <img
              src="assets/img/icon/calendar.svg"
              alt="date-icon"
              class="date-icon"
            />
            <input
              type="text"
              id="checkInDate"
              data-filter="checkIn"
              class="date-start"
              placeholder="Ngày nhận phòng"
            />
          </div>
          <div class="date2">
            <img
              src="assets/img/icon/calendar.svg"
              alt="date-icon"
              class="date-icon"
            />
            <input
              type="text"
              id="checkOutDate"
              data-filter="checkOut"
              class="date-end"
              placeholder="Ngày trả phòng"
            />
          </div>
        </div>
        <button class="search-button">TÌM KIẾM</button>
      </div>
    </div>

    <!-- Nội dung chính -->
    <main class="room-detail">
      <!-- Ảnh + chọn phòng -->
      <section class="top-section">
        <div class="gallery-grid">
          <div class="gallery-large">
            <img src="" alt="Ảnh lớn" />
          </div>
          <div class="gallery-small">
            <img src="" alt="Ảnh nhỏ 1" />
            <img src="" alt="Ảnh nhỏ 2" />
            <img src="" alt="Ảnh nhỏ 3" />
            <img src="" alt="Ảnh nhỏ 4" />
          </div>
        </div>

        <div class="top-nav-price-box">
          <div class="tab-links">
            <a href="#overview">Tổng quan</a>
            <a href="#room-list">Phòng nghỉ</a>
            <a href="#homestay-review">Đánh giá</a>
          </div>
          <div class="tab-price-action">
            <span class="label">Từ</span>
            <p class="price"><span id="min-price">---</span> VND/đêm</p>
          </div>
        </div>
      </section>

      <section class="info-section">
        <section class="overview" id="overview">
          <h2 class="homestay-name" id="homestay-name"></h2>
          <p class="address" id="homestay-address"></p>
          <p class="desc" id="homestay-description"></p>
          <p class="contactInfo" id="contact-info"></p>
        </section>

        <section class="room-list" id="room-list">
          <h2>Phòng còn trống tại đây</h2>
        </section>

        <section class="homestay-review" id="homestay-review">
          <h2>Bình luận và đánh giá</h2>

          <form class="review-form" novalidate>
            <h4>Đánh giá của bạn</h4>
            <fieldset class="rating-stars" aria-label="Đánh giá sao">
              <input type="radio" name="rating" id="star5" value="5" />
              <label for="star5" class="star-label" title="5 sao">★</label>
              <input type="radio" name="rating" id="star4" value="4" />
              <label for="star4" class="star-label" title="4 sao">★</label>
              <input type="radio" name="rating" id="star3" value="3" />
              <label for="star3" class="star-label" title="3 sao">★</label>
              <input type="radio" name="rating" id="star2" value="2" />
              <label for="star2" class="star-label" title="2 sao">★</label>
              <input type="radio" name="rating" id="star1" value="1" />
              <label for="star1" class="star-label" title="1 sao">★</label>
            </fieldset>
            <textarea
              name="comment"
              placeholder="Hãy để lại bình luận của bạn tại đây!"
              rows="5"
              required
            ></textarea>
            <div class="button-container">
              <button type="submit" class="btn-submit-review">
                Gửi đánh giá
              </button>
            </div>
          </form>

          <div class="review-list" id="review-list"></div>
        </section>
      </section>
    </main>
  </body>
  <div id="popup-placeholder"></div>
  <script type="module">
    const lastDates = JSON.parse(localStorage.getItem("lastSearchDates"));
    if (lastDates) {
      document.getElementById("checkInDate").value = lastDates.checkIn;
      document.getElementById("checkOutDate").value = lastDates.checkOut;
    }

    document
      .querySelector(".search-button")
      .addEventListener("click", function () {
        const checkInDate = document.querySelector(".date-start").value;
        const checkOutDate = document.querySelector(".date-end").value;
        const today = new Date().toISOString().split("T")[0];

        // if (!checkInDate || !checkOutDate) {
        //   alert("Vui lòng chọn ngày nhận và trả phòng.");
        //   return;
        // }
      });
  </script>

  <script type="module">
    import { setupPopupEventListeners } from "./assets/js/popup-login.js";

    fetch("popup.html")
      .then((response) => response.text())
      .then((data) => {
        document.getElementById("popup-placeholder").innerHTML = data;
        setupPopupEventListeners();
      });
  </script>
  <script type="module" src="assets/js/main.js"></script>
  <script type="module">
    function decodeJWT(token) {
      const base64Url = token.split(".")[1];
      const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
      const payload = JSON.parse(
        decodeURIComponent(
          atob(base64)
            .split("")
            .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
            .join("")
        )
      );
      return payload;
    }

    // ===================== Main Logic =====================
    window.onload = function () {
      initRoomSearch();

      const homestayId = getHomestayIdFromURL();
      if (homestayId) {
        loadHomestayImages(homestayId);
      } else {
        console.warn("Không tìm thấy homestayId trên URL");
      }

      const lastDates = JSON.parse(localStorage.getItem("lastSearchDates"));
      if (lastDates?.autoSearch) {
        // Xóa để không tự động lần sau
        lastDates.autoSearch = false;
        localStorage.setItem("lastSearchDates", JSON.stringify(lastDates));

        // Delay chút cho chacs ăn
        setTimeout(() => {
          document.querySelector(".search-button")?.click();
        }, 200);
      }
    };

    function getHomestayIdFromURL() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    function loadHomestayImages(homestayId) {
      const token = localStorage.getItem("authToken");

      fetch(
        `http://localhost:8080/homestay/api/homestays/${homestayId}/images`,
        {
          method: "GET",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        }
      )
        .then((response) => {
          if (!response.ok) {
            throw new Error("Không thể lấy ảnh homestay");
          }
          return response.json();
        })
        .then((images) => {
          const galleryLarge = document.querySelector(".gallery-large img");
          const gallerySmall = document.querySelector(".gallery-small");

          if (images.length === 0) return;

          // Ảnh đầu tiên làm ảnh lớn
          galleryLarge.src = images[0].imageUrl;
          galleryLarge.alt = `Ảnh ${images[0].imageId}`;

          // Xóa ảnh nhỏ cũ (nếu có)
          gallerySmall.innerHTML = "";

          // Render các ảnh còn lại vào gallery-small
          images.slice(1).forEach((img) => {
            const imageEl = document.createElement("img");
            imageEl.src = img.imageUrl;
            imageEl.alt = `Ảnh ${img.imageId}`;
            gallerySmall.appendChild(imageEl);
          });
        })
        .catch((error) => {
          console.error("Lỗi khi load ảnh homestay:", error);
        });
    }

    function initRoomSearch() {
      const searchBtn = document.querySelector(".search-button");
      const checkInInput = document.querySelector(".date-start");
      const checkOutInput = document.querySelector(".date-end");
      const roomListSection = document.getElementById("room-list");
      const roomContainer = document.createElement("div");
      roomContainer.classList.add("room-items");
      roomListSection.appendChild(roomContainer);

      searchBtn.addEventListener("click", () => {
        const checkInDate = checkInInput.value;
        const checkOutDate = checkOutInput.value;
        const urlParams = new URLSearchParams(window.location.search);
        const homestayId = urlParams.get("id");

        if (!homestayId) {
          alert("Không tìm thấy ID của homestay.");
          return;
        }

        fetchRooms(
          homestayId,
          checkInDate,
          checkOutDate,
          roomContainer,
          checkInInput,
          checkOutInput
        );
      });
    }

    async function fetchRooms(
      homestayId,
      checkInDate,
      checkOutDate,
      roomContainer,
      checkInInput,
      checkOutInput
    ) {
      const checkIn = checkInDate.split("/").reverse().join("-");
      const checkOut = checkOutDate.split("/").reverse().join("-");
      try {
        let res;
        if (checkInDate && checkOutDate) {
          res = await fetch(
            `http://localhost:8080/homestay/api/rooms/available?homestayId=${homestayId}&checkInDate=${checkIn}&checkOutDate=${checkOut}`
          );
        } else {
          res = await fetch(
            `http://localhost:8080/homestay/api/rooms/valid-homestay/${homestayId}`
          );
        }

        const data = await res.json();

        roomContainer.innerHTML = "";

        if (!data.length) {
          roomContainer.innerHTML =
            "<p>Không có phòng trống trong thời gian này.</p>";
          return;
        }

        for (const r of data) {
          const imageUrl = await fetchRoomImage(r.roomId); // await hoạt động đúng ở đây
          const item = createRoomItem(r, imageUrl);
          roomContainer.appendChild(item);
        }

        attachBookingHandlers(checkInInput, checkOutInput);
      } catch (err) {
        console.error("Lỗi khi lấy phòng:", err);
        alert("Không thể tải danh sách phòng.");
      }
    }

    function createRoomItem(r, imageUrl) {
      const item = document.createElement("div");
      item.classList.add("room-item");
      item.dataset.roomId = r.roomId;

      item.innerHTML = `
    <div class="room-img">
      <img src="${imageUrl}" alt="Room Image" />
    </div>
    <div class="room-facilities">
      <h3 class="room-type">${r.roomType} Room</h3>
      <h4>Tiện nghi</h4>
      <div class="facilities-list">
        ${
          typeof r.features === "string"
            ? r.features
                .split(",")
                .map(
                  (a) =>
                    `<div class="facility-item"><i class="ti-check"></i> ${a.trim()}</div>`
                )
                .join("")
            : "<div class='facility-item'>Không có thông tin</div>"
        }
      </div>
    </div>
    <div class="room-price">
      <p class="price">${r.price.toLocaleString("vi-VN")} VND/đêm</p>
    </div>
    <div class="room-booking">
      <button class="btn-book-now" data-room-id="${r.roomId}">Đặt ngay</button>
    </div>
  `;

      return item;
    }

    function attachBookingHandlers(checkInInput, checkOutInput) {
      document.querySelectorAll(".btn-book-now").forEach((btn) => {
        btn.addEventListener("click", () => {
          const token = localStorage.getItem("authToken");
          if (!token) {
            alert("Vui lòng đăng nhập để đặt phòng.");
            return;
          }

          const payload = decodeJWT(token);
          const userId = payload.host_id || payload.sub || payload.userId;
          const roomId = btn.dataset.roomId;
          const checkInDate = checkInInput.value.split("/").reverse().join("-");
          const checkOutDate = checkOutInput.value
            .split("/")
            .reverse()
            .join("-");

          if (!checkInDate || !checkOutDate) {
            alert("Vui lòng chọn ngày nhận và trả phòng trước khi đặt phòng.");
            return;
          }

          const body = {
            roomId: Number(roomId),
            checkInDate,
            checkOutDate,
          };

          fetch("http://localhost:8080/homestay/api/bookings", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(body),
          })
            .then((res) => {
              if (!res.ok) throw new Error("Đặt phòng thất bại");
              return res.json();
            })
            .then((bookingData) => {
              const bookingId = bookingData.bookingId;
              return createPayment(bookingId, token);
            })
            .then((paymentUrl) => {
              if (paymentUrl) {
                window.location.href = paymentUrl;
              } else {
                alert("Không lấy được đường dẫn thanh toán.");
              }
            })
            .catch((err) => {
              console.error("Lỗi khi đặt phòng hoặc thanh toán:", err);
              alert("Có lỗi xảy ra trong quá trình đặt phòng hoặc thanh toán.");
            });
        });
      });
    }

    function createPayment(bookingId, token) {
      return fetch(
        `http://localhost:8080/homestay/api/payment/vnpay/create-url/${bookingId}`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${token}`,
          },
        }
      )
        .then((res) => {
          if (!res.ok) throw new Error("Không thể tạo đơn thanh toán");
          return res.json();
        })
        .then((data) => data.url);
    }

    async function fetchRoomImage(roomId) {
      try {
        const res = await fetch(
          `http://localhost:8080/homestay/api/rooms/${roomId}/images`
        );
        if (!res.ok) throw new Error("No image");
        const data = await res.json();
        return data[0].imageUrl || "assets/img/default-thumbnail.webp";
      } catch (error) {
        console.error("Không lấy được ảnh chính cho room:", roomId, error);
        return "assets/img/standard-double.webp"; // fallback ảnh mặc định
      }
    }
  </script>
  <script type="module">
    const dateStart = flatpickr(".date-start", {
      dateFormat: "d/m/Y",
      locale: "vi",
      minDate: "today",
      onChange: function (selectedDates, dateStr, instance) {
        const dateStartValue = selectedDates[0];
        if (dateStartValue) {
          dateEnd.set("minDate", dateStartValue);
        }
      },
    });
    const dateEnd = flatpickr(".date-end", {
      dateFormat: "d/m/Y",
      locale: "vi",
      minDate: "today",
      onChange: function (selectedDates, dateStr, instance) {
        const dateEndValue = selectedDates[0];
        if (dateEndValue) {
          dateStart.set("maxDate", dateEndValue);
        }
      },
    });
    import { setupPopupEventListeners } from "./assets/js/popup-login.js";
    fetch("popup.html")
      .then((response) => response.text())
      .then((data) => {
        document.getElementById("popup-placeholder").innerHTML = data;
        setupPopupEventListeners();
      });
  </script>
  <script type="module" src="assets/js/review-and-info.js"></script>
  <script type="module" src="assets/js/main.js"></script>
  <script type="module" src="assets/js/role-redirect.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</html>
